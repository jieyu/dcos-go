# zstorage

A ZK-based object storage library

## Overview

This library facilitates the storage of data in Zookeeper.

At a high level, the Store supports the following API:

	Put(item Item) (Ident, error)
	Get(ident Ident) (item Item, found bool, err error)
	List(category string) (locations []Location, found bool, err error)
	Versions(location Location) (versions []string, found bool, err error)
	Delete(ident Ident) (found bool, err error)
	Close() error

Many of the API methods return a `found bool`.  This helps the client distinguish between "empty results" versus "the item could not be found"
	
## Nomenclature

An Item fully represents an item in the datastore.  Clients will provide an Item when Putting data and will receive an Item when Getting data.

An Item is fully identified by a composed Ident.  The Ident points to a Location and also an optional Version and an optional ZKVersion.

## Versions

An item may have any number of versions. Note that this is different from the ZKVersion which is described below.  If a client Puts an item with a version, it will live as a child of the current node for that item.

Additionally, when deleting an item, the user may specify a version.  If no version is specified when deleting an item, that item and all of its versions will be deleted.

## Paths

Here is an example of how a typical path might look like in the system:

	/[basePath]/[category]/buckets/[bucket]/[name]/[version]
	
The `basePath` can be configured on the Store, and will be prepended to any znode path that is generated for an operation.

The `category`, `name`, and `version` parts are set on the item's Ident property.

The `bucket` is generated by the Store using a configurable hashing function.  It is derived by hashing the item `name`.  The number of buckets to which a name might possibly hash can be configured when constructing the store.

## Optimistic Locking

Part of an item's Ident is a `*int32` field called `ZKVersion`.  

When performing a Get, the Store will set the `ZKVersion` on the returned Item.  This allows the client to specify that version when performing a subsequent mutating operation.

If this is set on an item's Ident property when performing a mutating operation, it will ensure that the item that is updated is specifically that version when setting it.  If another client happened to set the item before the first client was able to do so, the library will return the `ErrVersionConflict` error.  At this point, the client may choose to do another read and try again.